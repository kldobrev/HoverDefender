#include <gb/gb.h>
#include "machine.c"
#include "tiles/endingcutsctiles.c"
#include "tiles/fortsfiretiles.c"
#include "maps/endingcutscmap.c"
#include "hUGEDriver.h"


extern const hUGESong_t epiloguetheme;
extern UINT8 i, oamidx, camtileidx;
extern Machine * pl;



const UINT8 epiloguetext[] = {
    0xFE, 0x13, 0x00, 0x0C, 0x0B, 0x1C, 0x0F, 0x16, 0x23, 0x00, 0x17, 0x0B, 0x0E, 0x0F, 0x00, 0x13, 0x1E, 0xFE,
    0x19, 0x1F, 0x1E, 0x00, 0x13, 0x18, 0x00, 0x1E, 0x13, 0x17, 0x0F, 0x27, 0x00, 0x21, 0x0F, 0x16, 0x16, 0x29, 0xFE,
    0x10, 0x19, 0x1C, 0x1E, 0x00, 0x1D, 0x1E, 0x1C, 0x0B, 0x1E, 0x19, 0x1D, 0x00, 0x13, 0x1D, 0x00, 0x18, 0x19, 0xFE,
    0x17, 0x19, 0x1C, 0x0F, 0x26, 0x00, 0x1E, 0x12, 0x0F, 0x00, 0x17, 0x13, 0x16, 0x13, 0x1E, 0x0B, 0x1C, 0x23, 0xFE,
    0x21, 0x13, 0x16, 0x16, 0x00, 0x12, 0x0B, 0x20, 0x0F, 0x00, 0x1E, 0x19, 0xFE,
    0x1C, 0x0F, 0x16, 0x23, 0x00, 0x19, 0x18, 0x00, 0x16, 0x0F, 0x1D, 0x1D, 0xFE,
    0x1A, 0x19, 0x21, 0x0F, 0x1C, 0x10, 0x1F, 0x16, 0x00, 0x21, 0x0F, 0x0B, 0x1A, 0x19, 0x18, 0x1D, 0xFE,
    0x10, 0x19, 0x1C, 0x00, 0x1E, 0x12, 0x0F, 0x00, 0x1E, 0x13, 0x17, 0x0F, 0xFE,
    0x0C, 0x0F, 0x13, 0x18, 0x11, 0x26, 0x00, 0x13, 0x2A, 0x20, 0x0F, 0x00, 0x18, 0x0F, 0x20, 0x0F, 0x1C, 0xFE,
    0x16, 0x13, 0x15, 0x0F, 0x0E, 0x00, 0x1E, 0x12, 0x0B, 0x1E, 0x00, 0x1A, 0x16, 0x0B, 0x0D, 0x0F, 0xFE,
    0x0B, 0x18, 0x23, 0x21, 0x0B, 0x23, 0x26, 0xFE,
    0xFE,
    0x21, 0x12, 0x23, 0x00, 0x21, 0x0B, 0x1D, 0x00, 0x1F, 0x16, 0x1E, 0x11, 0x0F, 0x18, 0xFE,
    0x21, 0x13, 0x16, 0x16, 0x13, 0x18, 0x11, 0x00, 0x1E, 0x19, 0x00, 0x11, 0x19, 0x00, 0x1E, 0x19, 0xFE,
    0x1D, 0x1F, 0x0D, 0x12, 0x00, 0x0F, 0x22, 0x1E, 0x1C, 0x0F, 0x17, 0x0F, 0x1D, 0x00, 0x10, 0x19, 0x1C, 0xFE,
    0x17, 0x19, 0x1C, 0x0F, 0x00, 0x1A, 0x19, 0x21, 0x0F, 0x1C, 0x28, 0xFE,
    0x12, 0x19, 0x21, 0x00, 0x0E, 0x13, 0x0E, 0x00, 0x12, 0x0F, 0x00, 0x11, 0x0F, 0x1E, 0xFE,
    0x1D, 0x19, 0x00, 0x17, 0x0B, 0x18, 0x23, 0x00, 0x1E, 0x19, 0x00, 0x10, 0x19, 0x16, 0x16, 0x19, 0x21, 0xFE,
    0x12, 0x13, 0x17, 0x28, 0x00, 0x0B, 0x1E, 0x00, 0x16, 0x0F, 0x0B, 0x1D, 0x1E, 0x00, 0x12, 0x0F, 0xFE,
    0x21, 0x13, 0x16, 0x16, 0x00, 0x18, 0x19, 0x1E, 0x00, 0x1E, 0x12, 0x1C, 0x0F, 0x0B, 0x1E, 0x0F, 0x18, 0xFE,
    0x0B, 0x18, 0x23, 0x19, 0x18, 0x0F, 0x00, 0x0B, 0x18, 0x23, 0x17, 0x19, 0x1C, 0x0F, 0x26, 0xFE, 
    0xFE,
    0x13, 0x00, 0x1A, 0x1C, 0x0F, 0x20, 0x0F, 0x18, 0x1E, 0x0F, 0x0E, 0xFE,
    0x0B, 0x00, 0x11, 0x1C, 0x0F, 0x0B, 0x1E, 0x00, 0x0E, 0x13, 0x1D, 0x0B, 0x1D, 0x1E, 0x0F, 0x1C, 0xFE,
    0x1E, 0x19, 0x0E, 0x0B, 0x23, 0x00, 0x0B, 0x18, 0x0E, 0x00, 0x13, 0x00, 0x0D, 0x19, 0x1F, 0x16, 0x0E, 0xFE,
    0x18, 0x19, 0x1E, 0x00, 0x12, 0x0B, 0x20, 0x0F, 0x00, 0x0E, 0x19, 0x18, 0x0F, 0x00, 0x13, 0x1E, 0xFE,
    0x21, 0x13, 0x1E, 0x12, 0x19, 0x1F, 0x1E, 0x00, 0x23, 0x19, 0x1F, 0x1C, 0x00, 0x12, 0x0F, 0x16, 0x1A, 0x27, 0xFE,
    0x1E, 0x12, 0x0B, 0x18, 0x15, 0x00, 0x23, 0x19, 0x1F, 0x00, 0x10, 0x19, 0x1C, 0xFE,
    0x1D, 0x1E, 0x13, 0x0D, 0x15, 0x13, 0x18, 0x11, 0x00, 0x21, 0x13, 0x1E, 0x12, 0x00, 0x17, 0x0F, 0xFE,
    0x1F, 0x18, 0x1E, 0x13, 0x16, 0x00, 0x1E, 0x12, 0x0F, 0x00, 0x0F, 0x18, 0x0E, 0x27, 0xFE,
    0x18, 0x19, 0x21, 0x00, 0x13, 0x1E, 0x2A, 0x1D, 0x00, 0x1E, 0x13, 0x17, 0x0F, 0x00, 0x10, 0x19, 0x1C, 0xFE,
    0x0B, 0x00, 0x21, 0x0F, 0x16, 0x16, 0x00, 0x0E, 0x0F, 0x1D, 0x0F, 0x1C, 0x20, 0x0F, 0x0E, 0xFE,
    0x0C, 0x1C, 0x0F, 0x0B, 0x15, 0x26, 0x00, 0x11, 0x19, 0x19, 0x0E, 0x0C, 0x23, 0x0F, 0x27, 0x00, 0x00, 0x00, 0xFE, 0xFF    
};

const UINT8 fires[][3] = {{88, 28, 1}, {96, 26, 0}, {104, 24, 1}, {112, 25, 0}, {120, 26, 1}, {128, 24, 1}, {140, 27, 0}};




void custom_delay(UINT8 cycles) NONBANKED;
void incr_oam_sprite_tile_idx(INT8 steps) NONBANKED;
void reset_sprites(UINT8 fstsprite, UINT8 lastsprite) NONBANKED;
void anim_blackout() NONBANKED;
void anim_reverse_blackout() NONBANKED;
void place_machine(Machine * mch, UINT8 x, UINT8 y) NONBANKED;
void build_boss_road() NONBANKED;
void disable_bkg_scroll(UINT8 stageidx) NONBANKED;
inline UINT8 get_tile_idx(UINT8 newidxnum) NONBANKED;
void build_road() NONBANKED;
void move_machine(Machine * mch, INT8 speedx, INT8 speedy) NONBANKED;
void init_player() NONBANKED;
void toggle_mute_music(UINT8 toggleon) NONBANKED;
void hide_win_layer() BANKED;
void play_epilogue() BANKED;
void anim_inverted_bw_to_blackout_eplg() BANKED;
void anim_blackout_to_inverted_bw_eplg() BANKED;



void hide_win_layer() BANKED {
    HIDE_WIN;
}


void play_epilogue() BANKED {
    reset_sprites(0, 39);
    fill_win_rect(0, 0, 20, 1, 0);
    set_sprite_data(0, 3, fortsfiretiles);
    set_bkg_data(44, 92, endingcutsctiles);
    fill_bkg_rect(0, 0, 20, 18, 0);
    oamidx = 0;
    UINT8 cyclecnt = 1, textx = 1, texty = 20;
    const UINT8 * letter = epiloguetext;
    set_win_tiles(1, 1, 18, 8, endingcutscmap);
    move_bkg(0, 0);
    move_win(7, 0);
    SHOW_WIN;
    anim_blackout_to_inverted_bw_eplg();
    for(i = 0; i != 7; i++) {   // Initiating fire sprites
        move_sprite(oamidx, fires[i][0], fires[i][1]);
        set_sprite_tile(oamidx, fires[i][2]);
        incr_oam_sprite_tile_idx(1);
    }

    STAT_REG = 0x45;
    LYC_REG = 0x4F;
    add_LCD(hide_win_layer);
    enable_interrupts();
    set_interrupts(VBL_IFLAG | LCD_IFLAG);
    hUGE_init(&epiloguetheme);
    while(1) {
        SHOW_WIN;
        hUGE_dosound();
        if(cyclecnt % 8 == 0) {
            scroll_bkg(0, 1);
            texty = SCY_REG;
            if(texty % 8 == 0) {   // Time to display a line of text
                texty = SCY_REG >> 3;   // Getting bkg tile
                texty = texty + 18 > 32 ? (texty - 32) + 18 : texty + 18;   // Writing text 18 tiles after the current scroll position index
                if(*letter != 0xFF && (texty == 0 || texty % 2 == 0)) {   // There is text to be displayed
                    for(textx = 1; *letter != 0xFE; textx++, letter++) {    // Display a line of text
                        set_bkg_tile_xy(textx, texty, *letter);
                    }
                    fill_bkg_rect(1, texty + 2, 18, 1, 0);  // Erasing the previously written memory before writing
                    letter++;   // Get past the 0xFE
                } else if(*letter == 0xFF) {
                    fill_bkg_rect(1, texty, 18, 1, 0);  // Erasing old text after no more text to display
                    if(SCY_REG > 0xB4) {    // When no more text to display, wait until the scroll gets to y > 180 and break out of loop
                        break;
                    }
                }
            }
        }
        
        if(cyclecnt == 16) {
            for(i = 0; i != 7; i++) {
                set_sprite_tile(i, get_sprite_tile(i) == 0 ? 1 : 0);    // Animate airbase flames
            }
            cyclecnt = 1;
        } else {
            cyclecnt++;
        }
        
        wait_vbl_done();
    }
    toggle_mute_music(1);

    SHOW_WIN;
    reset_sprites(0, 7);
    anim_inverted_bw_to_blackout_eplg();
    LYC_REG = 0x00;
    __critical {
        remove_LCD(hide_win_layer);
    }
    move_bkg(0, 0);
    HIDE_WIN;
}


void anim_inverted_bw_to_blackout_eplg() BANKED {
    for(UINT8 blkstep = 0; blkstep != 21; blkstep++) {
        switch(blkstep) {
            case 1:
                BGP_REG = OBP0_REG = 0x67;
                break;
            case 10:
                BGP_REG = OBP0_REG = 0xAB;
                break;
            case 20:
                BGP_REG = OBP0_REG = 0xFF;
                break;
        }
        wait_vbl_done();
    }
}


void anim_blackout_to_inverted_bw_eplg() BANKED {
    OBP0_REG = 0xE4;
    for(UINT8 blkstep = 0; blkstep != 21; blkstep++) {
        switch(blkstep) {
            case 1:
                BGP_REG = 0xBF;
                break;
            case 10:
                BGP_REG = 0x7B;
                break;
            case 20:
                BGP_REG = 0x27;
                break;
        }
        wait_vbl_done();
    }
}

